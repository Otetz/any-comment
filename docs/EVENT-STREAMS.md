# Потоки событий

Оглавление
----------

* [GET /streams/first_level_changed/{entity_id}](#get-streamsfirst_level_changedentity_id) — Получение обновлений 
  комментариев сущности
  * [Пример использования](#Пример-использования)
  * [Форматы ответов](#Форматы-ответов)
    * [Новый комментарий к сущности](#Новый-комментарий-к-сущности) 
    * [Изменение комментария к сущности](#Изменение-комментария-к-сущности)
    * [Удаление комментария к сущности](#Удаление-комментария-к-сущности)

## GET /streams/first_level_changed/{entity_id} 

Канал получения обновлений комментариев первого уровня для сущности.

**Аргументы**: 
- *entity_id* (int) Идентификатор отследиваемой сущности  

**Возвращает**: Живой поток событий, пригодный для использования с `EventSource.js`. 

### Пример использования

**Подключение к потоку**:
```bash
curl -i -X GET http://HOSTNAME/api/1.0/streams/first_level_changed/321028
```

**Изменения в первом уровне комментариев сущности (выполнять в другом окне):**:
```bash
curl -X POST http://HOSTNAME/api/1.0/comments \
  -H 'content-type: application/json' \
  -d '{"userid": 324, "datetime": "2017-06-20T19:03:23.727040+03:00", "deleted": false, "text": "Erlang является декларативным языком программирования, который скорее …", "parentid": 321028}'

curl -X PUT http://HOSTNAME/api/1.0/comments/532361 \
  -H 'content-type: application/json' \
  -d '{"text": "Новый текст комментария"}'

curl -X DELETE http://HOSTNAME/api/1.0/comments/532361
```
Вот как эти изменения отобразяться в потоке:
```rest
HTTP/1.0 200 OK
Content-Type: text/event-stream; charset=utf-8
Connection: close
Server: Werkzeug/0.12.2 Python/3.5.2
Date: Tue, 27 Jun 2017 10:49:22 GMT

data: 1

data: {"record": {"comment_id": 532361, "entity_id": 534033}, "action": "new_comment", "now": "2017-06-27T13:49:34.448822+03:00"}

data: {"record": {"parentid": 321028, "deleted": false, "userid": 324, "datetime": "2017-06-20T19:03:23.727040+03:00", "text": "Новый текст комментария"}, "old_record": {"entityid": 534033, "parentid": 321028, "author": {"userid": 324, "name": "Ким Ефимов"}, "deleted": false, "text": "Erlang является декларативным языком программирования, который скорее …", "userid": 324, "commentid": 532361, "datetime": "2017-06-20T19:03:23.727040+03:00"}, "action": "update_comment", "now": "2017-06-27T13:49:49.565439+03:00"}

data: {"record": {"parentid": 321028, "deleted": true, "userid": 324, "datetime": "2017-06-20T19:03:23.727040+03:00", "text": "Новый текст комментария"}, "old_record": {"entityid": 534033, "parentid": 321028, "author": {"userid": 324, "name": "Ким Ефимов"}, "deleted": false, "text": "Новый текст комментария", "userid": 324, "commentid": 532361, "datetime": "2017-06-20T19:03:23.727040+03:00"}, "action": "update_comment", "now": "2017-06-27T13:50:02.789399+03:00"}

data: {"old_record": {"entityid": 534033, "parentid": 321028, "author": {"userid": 324, "name": "Ким Ефимов"}, "deleted": false, "text": "Новый текст комментария", "userid": 324, "commentid": 532361, "datetime": "2017-06-20T19:03:23.727040+03:00"}, "action": "delete_comment", "now": "2017-06-27T13:50:02.793304+03:00"}

```

### Форматы ответов

Ответы формируются в JSON-строки. События бывают следующихъ видов.
 
#### Новый комментарий к сущности 

Поля:
* *action* (str) — Для нового комментария всегда значение `new_comment`;
* *now* (datetime) — Дата и время регистрации события на сервере;
* *record* (dict) — Словарь данных ответа:
  * *entity_id* (int) — Идентификатор сущности нового комментария, может быть использован например для подписки уже 
    на его изменения;
  * *comment_id* (int) — Идентификатор непосредственно комментария, он понадобиться чтобы затем [получить полные 
    данные](./COMMENTS.md#get-commentscomment_id--Получить-информацию-о-Комментарии) комментария при необходимости.

#### Изменение комментария к сущности

Поля:
* *action* (str) — Для изменений в комментарии всегда значение `update_comment`;
* *now* (datetime) — Дата и время регистрации события на сервере;
* *record* (dict) — Получившаяся запись;
* *old_record* (dict) — Предыдущее состояние записи.

#### Удаление комментария к сущности

Поля:
* *action* (str) — Для удалённого комментария всегда значение `delete_comment`;
* *now* (datetime) — Дата и время регистрации события на сервере;
* *old_record* (dict) — Предыдущее состояние записи.

*Примечание*: В связи с тем, что удаление делается установкой флага для конкретной записи, то перед событием удаления 
придёт еще и событие изменений в записи.
