# Any Comment

[![Code Climate](https://img.shields.io/codeclimate/github/Otetz/any-comment.svg)](https://codeclimate.com/github/Otetz/any-comment)

Сервис комментариев.

Документация по API подробно представлена в разделе [docs](./docs/INDEX.md)
 
## TODO

- [x] Триггер на историю правок коммента
- [x] Тесты для комментариев
- [x] Пагинация везде где разумно
- [x] Получение комментариев первого уровня
- [x] Получение всех дочерних комментариев
- [x] История комментариев определенного пользователя
- [ ] Фильтр по дате
- [ ] Выгрузка в файлы
- [ ] Асинхронные задачи
- [ ] Docker deploy
- [ ] Подписка на комментарии

## На что можно обратить внимание

* [data_gen.py](./data_gen.py) — Генератор тестовых данных для базы данных.  
  Используется пара интересных пакетов:
  * `elizabeth` для создания непосредственно тестовых значений разных видов и назначения;
  * `tqdm` для отображения прогресса генерации каждого из этапов.

* [data_gen.py: grow_comments_tree()](./data_gen.py#L82)  
  При определённой заданием вложенности порядка **100**, растить дерево рекурсивно не хватит стэка :). Потому наращиваем 
  дерево по слоям/уровням.

* [app/comments.py: get_comments()](./app/comments.py#L26)  
  Если считать «в лоб», то заготовленный для этого индекс `comments_deleted_index` не поможет, база предпочтёт SeqScan, 
  что может быть совсем непроизводительно при дальнейшем росте числа записей. 
  Потому здесь количество живых записей вычисляется за два приёма:
  1. Берём из статистики базы данных число строк в таблице;
  2. Запрашиваем число удалённых записей (пока их доля меньше живых, должен предпочтитаться индекс).
    
  И вычитая одно из другого получаем число живых комментариев с максимально возможным быстродействием.

* [db_schema.sql: comments_log()](./db_schema.sql#L53)  
  Триггер `comments_log` с помощью одноимённой функции осуществляет фиксацию предыдущего значения для обновляемого 
    комментария в таблицу `comments_history`. 

* [db_schema.sql: comment_history()](./db_schema.sql#L137)  
  SQL-функция `comment_history` возвращает текущее состояние и истоию всех правок комментария.

* [db_schema.sql: comments_tree()](./db_schema.sql#L117)  
  Рекурсивная CTE-фнкция `comments_tree` позволяет получить всех потомков указанной сущности. Работает очень шустро.
